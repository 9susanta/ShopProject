<div class="product-batch-list-container">
  <!-- Header -->
  <div class="page-header mb-6">
    <div class="flex items-center gap-3 mb-2">
      <h1 class="text-3xl font-bold text-gray-800">Product Inventory</h1>
      <mat-chip color="primary" class="ml-2">{{ totalCount() }} products</mat-chip>
    </div>
    <p class="text-gray-600">Manage and view product inventory, batches, and stock levels</p>
  </div>

  <!-- Search and Filters Card -->
  <mat-card class="search-card mb-4">
    <mat-card-content class="p-4">
      <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search Products</mat-label>
          <input
            matInput
            [ngModel]="searchTerm()"
            (ngModelChange)="searchTerm.set($event)"
            (keyup.enter)="onSearch()"
            placeholder="Search by product name, SKU, or category" />
          <mat-icon matPrefix>search</mat-icon>
          @if (searchTerm()) {
            <button mat-icon-button matSuffix (click)="clearSearch()" [attr.aria-label]="'Clear search'">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>
        <div class="search-actions">
          <button mat-raised-button color="primary" (click)="onSearch()" [disabled]="loading()" class="search-button">
            <mat-icon>search</mat-icon>
            Search
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Products Table Card -->
  <mat-card class="table-card">
    <mat-card-header>
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center gap-2">
          <mat-icon class="text-primary">inventory_2</mat-icon>
          <mat-card-title>Products</mat-card-title>
        </div>
        <button mat-raised-button color="primary" routerLink="/admin/inventory/adjust">
          <mat-icon>edit</mat-icon>
          Stock Adjustment
        </button>
      </div>
    </mat-card-header>
    <mat-card-content>
      @if (loading()) {
        <div class="flex flex-col justify-center items-center p-12">
          <mat-spinner diameter="50"></mat-spinner>
          <p class="mt-4 text-gray-600">Loading products...</p>
        </div>
      } @else if (products().length === 0) {
        <div class="empty-state text-center py-12">
          <mat-icon class="text-gray-300 text-6xl mb-4">inventory_2</mat-icon>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">No products found</h3>
          <p class="text-gray-500 mb-6">
            @if (searchTerm()) {
              No products match your search criteria. Try a different search term.
            } @else {
              There are no products in inventory yet.
            }
          </p>
          @if (searchTerm()) {
            <button mat-raised-button color="primary" (click)="clearSearch()">
              <mat-icon>clear</mat-icon>
              Clear Search
            </button>
          }
        </div>
      } @else {
        <div class="overflow-x-auto">
          <table mat-table [dataSource]="products()" class="products-table">
            <!-- Product Name Column -->
            <ng-container matColumnDef="productName">
              <th mat-header-cell *matHeaderCellDef>Product</th>
              <td mat-cell *matCellDef="let product">
                <div class="flex items-center gap-3">
                  <div class="product-icon">
                    <mat-icon>inventory_2</mat-icon>
                  </div>
                  <div>
                    <div class="font-semibold text-base">{{ product.productName }}</div>
                    <div class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                      @if (product.categoryName) {
                        <span class="flex items-center gap-1">
                          <mat-icon class="text-xs">category</mat-icon>
                          {{ product.categoryName }}
                        </span>
                      }
                    </div>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- SKU Column -->
            <ng-container matColumnDef="sku">
              <th mat-header-cell *matHeaderCellDef>SKU</th>
              <td mat-cell *matCellDef="let product">
                @if (product.productSKU) {
                  <code class="sku-code">{{ product.productSKU }}</code>
                } @else {
                  <span class="text-gray-400">N/A</span>
                }
              </td>
            </ng-container>

            <!-- Total Quantity Column -->
            <ng-container matColumnDef="totalQuantity">
              <th mat-header-cell *matHeaderCellDef>Total Quantity</th>
              <td mat-cell *matCellDef="let product">
                <div class="quantity-display">
                  <span class="quantity-value">{{ product.totalQuantity ?? 0 }}</span>
                  <span class="quantity-label">units</span>
                </div>
              </td>
            </ng-container>

            <!-- Available Quantity Column -->
            <ng-container matColumnDef="availableQuantity">
              <th mat-header-cell *matHeaderCellDef>Available</th>
              <td mat-cell *matCellDef="let product">
                <div class="flex items-center gap-2">
                  <span class="available-quantity" [class.low-stock]="product.isLowStock">
                    {{ product.availableQuantity }}
                  </span>
                  @if (product.isLowStock) {
                    <mat-icon class="text-warn text-sm" matTooltip="Low stock warning">warning</mat-icon>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Low Stock Status Column -->
            <ng-container matColumnDef="lowStock">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let product">
                @if (product.isLowStock) {
                  <mat-chip color="warn" class="status-chip">
                    <mat-icon class="chip-icon">warning</mat-icon>
                    Low Stock
                  </mat-chip>
                } @else {
                  <mat-chip color="primary" class="status-chip">
                    <mat-icon class="chip-icon">check_circle</mat-icon>
                    In Stock
                  </mat-chip>
                }
              </td>
            </ng-container>

            <!-- Batches Column -->
            <ng-container matColumnDef="batches">
              <th mat-header-cell *matHeaderCellDef>Batches</th>
              <td mat-cell *matCellDef="let product">
                <div class="batch-info">
                  @if (product.batches && product.batches.length > 0) {
                    <div class="flex items-center gap-2">
                      <mat-icon class="text-gray-500 text-sm">layers</mat-icon>
                      <span [matTooltip]="getBatchSummary(product.batches)">
                        {{ product.batches.length }} batch{{ product.batches.length !== 1 ? 'es' : '' }}
                      </span>
                      @if (hasExpiringBatches(product.batches)) {
                        <mat-chip class="expiry-chip" color="accent">
                          <mat-icon class="chip-icon-small">schedule</mat-icon>
                          Expiring
                        </mat-chip>
                      }
                    </div>
                  } @else {
                    <span class="text-gray-400">No batches</span>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let product">
                <div class="flex gap-2">
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="viewDetails(product)"
                    matTooltip="View product details"
                    class="action-button">
                    <mat-icon>visibility</mat-icon>
                    Details
                  </button>
                  <button
                    mat-raised-button
                    color="accent"
                    (click)="viewBatches(product)"
                    matTooltip="View all batches for this product"
                    class="action-button">
                    <mat-icon>inventory_2</mat-icon>
                    Batches
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="table-header"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns" class="table-row"></tr>
            
            <!-- No data row -->
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                <div class="text-center py-8 text-gray-500">
                  No products found
                </div>
              </td>
            </tr>
          </table>
        </div>

        <!-- Pagination -->
        <mat-paginator
          [length]="totalCount()"
          [pageSize]="pageSize()"
          [pageIndex]="pageNumber() - 1"
          [pageSizeOptions]="[10, 20, 50, 100]"
          (page)="onPageChange($event)"
          showFirstLastButtons
          class="mt-4">
        </mat-paginator>
      }
    </mat-card-content>
  </mat-card>
</div>
