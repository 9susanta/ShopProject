<div class="dashboard-container p-4">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Inventory Dashboard</h1>
    <button mat-raised-button color="primary" (click)="refresh()" [disabled]="!hasAccess()">
      <mat-icon>refresh</mat-icon>
      Refresh
    </button>
  </div>

  @if (!hasAccess()) {
    <mat-card class="p-6">
      <mat-card-content>
        <div class="flex flex-col items-center justify-center text-center">
          <mat-icon class="text-red-500 text-6xl mb-4">lock</mat-icon>
          <h2 class="text-xl font-bold mb-2">Access Denied</h2>
          <p class="text-gray-600 mb-4">
            You do not have permission to access inventory data. This feature requires SuperAdmin, Admin, or Staff role.
          </p>
          <p class="text-sm text-gray-500">
            Please contact your administrator if you believe you should have access to this feature.
          </p>
        </div>
      </mat-card-content>
    </mat-card>
  } @else if (loading()) {
    <div class="flex justify-center p-8">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <!-- Total SKUs -->
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm mb-1">Total SKUs</p>
              <p class="text-3xl font-bold">{{ totalSKUs() }}</p>
            </div>
            <mat-icon class="text-blue-500 text-4xl">inventory_2</mat-icon>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Total Stock Value -->
      <mat-card class="summary-card">
        <mat-card-content>
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm mb-1">Total Stock Value</p>
              <p class="text-3xl font-bold">{{ totalStockValue() | currency: 'INR' }}</p>
            </div>
            <mat-icon class="text-green-500 text-4xl">attach_money</mat-icon>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Low Stock Count -->
      <mat-card class="summary-card" [class.alert-card]="lowStockCount() > 0" routerLink="/admin/inventory/low-stock">
        <mat-card-content>
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm mb-1">Low Stock Items</p>
              <p class="text-3xl font-bold" [class.text-red-600]="lowStockCount() > 0">
                {{ lowStockCount() }}
              </p>
            </div>
            <mat-icon class="text-orange-500 text-4xl">warning</mat-icon>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Expiry Soon Count -->
      <mat-card class="summary-card" [class.alert-card]="expirySoonCount() > 0" routerLink="/admin/inventory/expiry">
        <mat-card-content>
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-500 text-sm mb-1">Expiring Soon</p>
              <p class="text-3xl font-bold" [class.text-red-600]="expirySoonCount() > 0">
                {{ expirySoonCount() }}
              </p>
            </div>
            <mat-icon class="text-red-500 text-4xl">schedule</mat-icon>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Quick Actions -->
    <mat-card class="mb-6">
      <mat-card-header>
        <mat-card-title>Quick Actions</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="flex flex-wrap gap-4">
          <button mat-raised-button color="primary" routerLink="/admin/inventory/products">
            <mat-icon>list</mat-icon>
            View All Products
          </button>
          <button mat-raised-button color="accent" routerLink="/admin/inventory/low-stock">
            <mat-icon>warning</mat-icon>
            Low Stock Items
          </button>
          <button mat-raised-button color="warn" routerLink="/admin/inventory/expiry">
            <mat-icon>schedule</mat-icon>
            Expiring Soon
          </button>
          <button mat-raised-button routerLink="/admin/inventory/adjust">
            <mat-icon>edit</mat-icon>
            Stock Adjustment
          </button>
          <button mat-raised-button routerLink="/admin/purchasing/purchase-orders/new">
            <mat-icon>add_shopping_cart</mat-icon>
            Create Purchase Order
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Recent Purchase Orders & GRNs -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <!-- Recent Purchase Orders -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>Recent Purchase Orders</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (loadingPOs()) {
            <div class="flex justify-center p-4">
              <mat-spinner diameter="30"></mat-spinner>
            </div>
          } @else if (recentPurchaseOrders().length === 0) {
            <p class="text-gray-500 text-center py-4">No recent purchase orders</p>
          } @else {
            <div class="overflow-x-auto">
              <table mat-table [dataSource]="recentPurchaseOrders()" class="w-full">
                <ng-container matColumnDef="poNumber">
                  <th mat-header-cell *matHeaderCellDef>PO Number</th>
                  <td mat-cell *matCellDef="let po">
                    <div class="font-semibold cursor-pointer hover:text-blue-600" (click)="viewPurchaseOrder(po.id)">
                      {{ po.orderNumber }}
                    </div>
                  </td>
                </ng-container>
                <ng-container matColumnDef="supplier">
                  <th mat-header-cell *matHeaderCellDef>Supplier</th>
                  <td mat-cell *matCellDef="let po">{{ po.supplierName || 'N/A' }}</td>
                </ng-container>
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let po">
                    <mat-chip [color]="getPOStatusColor(po.status)">
                      {{ getPOStatusText(po.status) }}
                    </mat-chip>
                  </td>
                </ng-container>
                <ng-container matColumnDef="totalAmount">
                  <th mat-header-cell *matHeaderCellDef>Amount</th>
                  <td mat-cell *matCellDef="let po">{{ po.totalAmount | currency: 'INR' }}</td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['poNumber', 'supplier', 'status', 'totalAmount']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['poNumber', 'supplier', 'status', 'totalAmount']"></tr>
              </table>
            </div>
            <div class="mt-4 text-center">
              <button mat-button routerLink="/admin/purchasing/purchase-orders">View All POs</button>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Recent GRNs (Auto Stock Updates) -->
      <mat-card>
        <mat-card-header>
          <mat-card-title>Recent GRNs (Stock Updates)</mat-card-title>
          <mat-card-subtitle>Auto stock updates from confirmed GRNs</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          @if (loadingGRNs()) {
            <div class="flex justify-center p-4">
              <mat-spinner diameter="30"></mat-spinner>
            </div>
          } @else if (recentGRNs().length === 0) {
            <p class="text-gray-500 text-center py-4">No recent GRNs</p>
          } @else {
            <div class="overflow-x-auto">
              <table mat-table [dataSource]="recentGRNs()" class="w-full">
                <ng-container matColumnDef="grnNumber">
                  <th mat-header-cell *matHeaderCellDef>GRN Number</th>
                  <td mat-cell *matCellDef="let grn">
                    <div class="font-semibold cursor-pointer hover:text-blue-600" (click)="viewGRN(grn.id)">
                      {{ grn.grnNumber }}
                    </div>
                  </td>
                </ng-container>
                <ng-container matColumnDef="poNumber">
                  <th mat-header-cell *matHeaderCellDef>PO Number</th>
                  <td mat-cell *matCellDef="let grn">{{ grn.purchaseOrderNumber }}</td>
                </ng-container>
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>Status</th>
                  <td mat-cell *matCellDef="let grn">
                    <mat-chip [color]="getGRNStatusColor(grn.status)">
                      {{ getGRNStatusText(grn.status) }}
                    </mat-chip>
                  </td>
                </ng-container>
                <ng-container matColumnDef="confirmedDate">
                  <th mat-header-cell *matHeaderCellDef>Confirmed</th>
                  <td mat-cell *matCellDef="let grn">
                    {{ grn.confirmedAt | date: 'short' }}
                  </td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="['grnNumber', 'poNumber', 'status', 'confirmedDate']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['grnNumber', 'poNumber', 'status', 'confirmedDate']"></tr>
              </table>
            </div>
            <div class="mt-4 text-center">
              <button mat-button routerLink="/admin/purchasing/grn">View All GRNs</button>
            </div>
          }
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Valuation Breakdown -->
    @if (valuation()?.breakdownByCategory && valuation()!.breakdownByCategory!.length > 0) {
      <mat-card>
        <mat-card-header>
          <mat-card-title>Valuation by Category</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b">
                  <th class="text-left p-2">Category</th>
                  <th class="text-right p-2">SKUs</th>
                  <th class="text-right p-2">Quantity</th>
                  <th class="text-right p-2">Value</th>
                </tr>
              </thead>
              <tbody>
                @for (category of valuation()!.breakdownByCategory!; track category.categoryId) {
                  <tr class="border-b hover:bg-gray-50">
                    <td class="p-2">{{ category.categoryName }}</td>
                    <td class="text-right p-2">{{ category.skuCount }}</td>
                    <td class="text-right p-2">{{ category.totalQuantity }}</td>
                    <td class="text-right p-2 font-semibold">{{ category.totalValue | currency: 'INR' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    }
  }
</div>

