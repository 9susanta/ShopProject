<div class="po-form-container p-4 max-w-6xl mx-auto">
  <h1 class="text-2xl font-bold mb-6">{{ isEditMode() ? 'Edit' : 'Create' }} Purchase Order</h1>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
    <!-- Header Section -->
    <div class="bg-white p-6 rounded-lg shadow">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Supplier *</mat-label>
          <input
            matInput
            formControlName="supplierId"
            [matAutocomplete]="supplierAuto"
            (input)="filterSuppliers($any($event.target).value || '')" />
          <mat-autocomplete #supplierAuto="matAutocomplete">
            @for (supplier of filteredSuppliers(); track supplier.id) {
              <mat-option [value]="supplier.id">{{ supplier.name }}</mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Expected Delivery Date</mat-label>
          <input matInput formControlName="expectedDeliveryDate" [matDatepicker]="picker" />
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="w-full mt-4">
        <mat-label>Remarks</mat-label>
        <textarea matInput formControlName="remarks" rows="2"></textarea>
      </mat-form-field>
    </div>

    <!-- Items Section -->
    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Items</h2>
        <button type="button" mat-raised-button color="primary" (click)="addItem()">
          <mat-icon>add</mat-icon>
          Add Item
        </button>
      </div>

      <div class="overflow-x-auto">
        <table mat-table [dataSource]="items.controls" class="w-full">
          <ng-container matColumnDef="product">
            <th mat-header-cell *matHeaderCellDef>Product *</th>
            <td mat-cell *matCellDef="let item; let i = index">
              <mat-form-field appearance="outline" class="w-full">
            <input
              matInput
              [formControl]="item.get('productId')!"
              [matAutocomplete]="productAuto"
              (input)="filterProducts($any($event.target).value || '')"
              placeholder="Search product or scan barcode" />
                <mat-autocomplete #productAuto="matAutocomplete">
                  @for (product of filteredProducts(); track product.id) {
                    <mat-option [value]="product.id">{{ product.name }} ({{ product.sku }})</mat-option>
                  }
                </mat-autocomplete>
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>Quantity *</th>
            <td mat-cell *matCellDef="let item">
              <mat-form-field appearance="outline" class="w-full">
                <input matInput type="number" [formControl]="item.get('quantity')!" min="0.01" step="0.01" />
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="unit">
            <th mat-header-cell *matHeaderCellDef>Unit *</th>
            <td mat-cell *matCellDef="let item">
              <mat-form-field appearance="outline" class="w-full">
                <mat-select [formControl]="item.get('unit')!">
                  @for (unit of units(); track unit.id) {
                    <mat-option [value]="unit.id">{{ unit.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="unitPrice">
            <th mat-header-cell *matHeaderCellDef>Unit Price *</th>
            <td mat-cell *matCellDef="let item">
              <mat-form-field appearance="outline" class="w-full">
                <input matInput type="number" [formControl]="item.get('unitPrice')!" min="0" step="0.01" />
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="gstRate">
            <th mat-header-cell *matHeaderCellDef>GST % *</th>
            <td mat-cell *matCellDef="let item">
              <mat-form-field appearance="outline" class="w-full">
                <input matInput type="number" [formControl]="item.get('gstRate')!" min="0" max="100" step="0.01" />
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let item">
              {{ getItemTotal(item) | currency: 'INR' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let item; let i = index">
              <button type="button" mat-icon-button color="warn" (click)="removeItem(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>

      @if (items.length === 0) {
        <p class="text-gray-500 text-center py-8">No items added. Click "Add Item" to start.</p>
      }
    </div>

    <!-- Summary Section -->
    <div class="bg-white p-6 rounded-lg shadow">
      <div class="flex justify-end">
        <div class="summary-box">
          <div class="flex justify-between mb-2">
            <span class="font-semibold">Subtotal:</span>
            <span>{{ getTotalAmount() - getTotalGST() | currency: 'INR' }}</span>
          </div>
          <div class="flex justify-between mb-2">
            <span class="font-semibold">GST:</span>
            <span>{{ getTotalGST() | currency: 'INR' }}</span>
          </div>
          <div class="flex justify-between text-xl font-bold pt-2 border-t">
            <span>Total:</span>
            <span>{{ getTotalAmount() | currency: 'INR' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-end gap-4">
      <button type="button" mat-button (click)="onCancel()">Cancel</button>
      <button type="submit" mat-raised-button color="primary" [disabled]="loading() || form.invalid">
        @if (loading()) {
          <mat-spinner diameter="20"></mat-spinner>
        } @else {
          {{ isEditMode() ? 'Update' : 'Create' }} Purchase Order
        }
      </button>
    </div>
  </form>
</div>

