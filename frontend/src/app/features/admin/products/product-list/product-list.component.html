<div class="admin-page-container">
  <div class="admin-page-header">
    <h1>Products</h1>
    <div class="header-actions">
      <a routerLink="/admin/products/new" class="btn btn-primary">
        <span class="material-icons">add</span>
        New Product
      </a>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="filters-grid">
      <div class="filter-group">
        <label for="search" class="form-label">Search</label>
        <input
          id="search"
          type="text"
          class="form-control"
          [value]="searchTerm()"
          (input)="onSearchInput($any($event.target).value)"
          (keyup.enter)="onSearch()"
          placeholder="Search by name, SKU, or barcode"
        />
      </div>
      <div class="filter-group">
        <label for="category" class="form-label">Category</label>
        <mat-form-field appearance="outline" class="category-filter-field">
          <mat-select
            id="category"
            [value]="categoryFilter()"
            (selectionChange)="categoryFilter.set($event.value); onFilterChange()"
            placeholder="Select Categories"
            multiple>
            <mat-select-trigger>
              @if (categoryFilter().length === 0) {
                <span class="select-placeholder">All Categories</span>
              } @else if (categoryFilter().length === 1) {
                <span>{{ getCategoryName(categoryFilter()[0]) }}</span>
              } @else {
                <span>{{ categoryFilter().length }} selected</span>
              }
            </mat-select-trigger>
            <!-- Search input -->
            <div class="category-search-container">
              <input
                matInput
                type="text"
                placeholder="Search categories..."
                [value]="categorySearchTerm()"
                (input)="categorySearchTerm.set($any($event.target).value)"
                (click)="$event.stopPropagation()"
                class="category-search-input" />
            </div>
            <!-- Filtered category options -->
            @for (category of filteredCategories(); track category.id) {
              <mat-option [value]="category.id">
                {{ category.name }}
              </mat-option>
            }
            @if (filteredCategories().length === 0) {
              <mat-option disabled>No categories found</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
      <div class="filter-group">
        <label for="lowStock" class="form-label">Low Stock</label>
        <mat-form-field appearance="outline" class="low-stock-filter-field">
          <mat-select
            id="lowStock"
            [value]="getLowStockFilterValue()"
            (selectionChange)="onLowStockChange($event.value)"
            placeholder="All">
            <mat-option value="">All</mat-option>
            <mat-option value="true">Yes</mat-option>
            <mat-option value="false">No</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="filter-actions">
        <button class="btn btn-primary" (click)="onSearch()">Search</button>
        <button
          class="btn btn-secondary"
          (click)="searchTerm.set(''); categoryFilter.set([]); categorySearchTerm.set(''); supplierFilter.set(''); lowStockFilter.set(undefined); onFilterChange()">
          Clear
        </button>
      </div>
    </div>
  </div>

  <!-- Products Table -->
  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading products...</p>
    </div>
  } @else {
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onSortChange($event)" class="products-table mat-elevation-z0">
        <!-- Product Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="name" [disableClear]="true">
            <span class="sort-header-content">Product Name</span>
            <span class="sort-arrows">
              <span class="sort-arrow sort-arrow-up" (click)="sortByColumn('name', 'asc'); $event.stopPropagation()" title="Sort ascending">▲</span>
              <span class="sort-arrow sort-arrow-down" (click)="sortByColumn('name', 'desc'); $event.stopPropagation()" title="Sort descending">▼</span>
            </span>
          </th>
          <td mat-cell *matCellDef="let product">
            <a [routerLink]="['/admin/products', product.id]" class="product-link">
              {{ product.name }}
            </a>
          </td>
        </ng-container>

        <!-- SKU Column -->
        <ng-container matColumnDef="sku">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="sku" [disableClear]="true">
            <span class="sort-header-content">SKU</span>
            <span class="sort-arrows">
              <span class="sort-arrow sort-arrow-up" (click)="sortByColumn('sku', 'asc'); $event.stopPropagation()" title="Sort ascending">▲</span>
              <span class="sort-arrow sort-arrow-down" (click)="sortByColumn('sku', 'desc'); $event.stopPropagation()" title="Sort descending">▼</span>
            </span>
          </th>
          <td mat-cell *matCellDef="let product">{{ product.sku }}</td>
        </ng-container>

        <!-- Barcode Column -->
        <ng-container matColumnDef="barcode">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="barcode" [disableClear]="true">
            <span class="sort-header-content">Barcode</span>
            <span class="sort-arrows">
              <span class="sort-arrow sort-arrow-up" (click)="sortByColumn('barcode', 'asc'); $event.stopPropagation()" title="Sort ascending">▲</span>
              <span class="sort-arrow sort-arrow-down" (click)="sortByColumn('barcode', 'desc'); $event.stopPropagation()" title="Sort descending">▼</span>
            </span>
          </th>
          <td mat-cell *matCellDef="let product">{{ product.barcode || '-' }}</td>
        </ng-container>

        <!-- Sale Price Column -->
        <ng-container matColumnDef="salePrice">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="salePrice" [disableClear]="true">
            <span class="sort-header-content">Sale Price</span>
            <span class="sort-arrows">
              <span class="sort-arrow sort-arrow-up" (click)="sortByColumn('salePrice', 'asc'); $event.stopPropagation()" title="Sort ascending">▲</span>
              <span class="sort-arrow sort-arrow-down" (click)="sortByColumn('salePrice', 'desc'); $event.stopPropagation()" title="Sort descending">▼</span>
            </span>
          </th>
          <td mat-cell *matCellDef="let product">₹{{ product.salePrice?.toFixed(2) || '0.00' }}</td>
        </ng-container>

        <!-- MRP Column -->
        <ng-container matColumnDef="mrp">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="mrp" [disableClear]="true">
            <span class="sort-header-content">MRP</span>
            <span class="sort-arrows">
              <span class="sort-arrow sort-arrow-up" (click)="sortByColumn('mrp', 'asc'); $event.stopPropagation()" title="Sort ascending">▲</span>
              <span class="sort-arrow sort-arrow-down" (click)="sortByColumn('mrp', 'desc'); $event.stopPropagation()" title="Sort descending">▼</span>
            </span>
          </th>
          <td mat-cell *matCellDef="let product">₹{{ product.mrp?.toFixed(2) || '0.00' }}</td>
        </ng-container>

        <!-- Stock Column -->
        <ng-container matColumnDef="stock">
          <th mat-header-cell *matHeaderCellDef>
            <span class="sort-header-content">Stock</span>
          </th>
          <td mat-cell *matCellDef="let product">
            <span 
              class="stock-quantity"
              [class.stock-low]="product.availableQuantity !== undefined && product.availableQuantity <= product.lowStockThreshold"
              [class.stock-out]="product.availableQuantity === 0"
              [class.stock-unknown]="product.availableQuantity === undefined">
              @if (product.availableQuantity !== undefined) {
                {{ product.availableQuantity | number: '1.0-0' }}@if (product.unitName) { ({{ product.unitName }}) }
              } @else {
                <span class="stock-na">-</span>
              }
            </span>
          </td>
        </ng-container>

        <!-- Category Column -->
        <ng-container matColumnDef="categoryName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="categoryName" [disableClear]="true">
            <span class="sort-header-content">Category</span>
            <span class="sort-arrows">
              <span class="sort-arrow sort-arrow-up" (click)="sortByColumn('categoryName', 'asc'); $event.stopPropagation()" title="Sort ascending">▲</span>
              <span class="sort-arrow sort-arrow-down" (click)="sortByColumn('categoryName', 'desc'); $event.stopPropagation()" title="Sort descending">▼</span>
            </span>
          </th>
          <td mat-cell *matCellDef="let product">{{ product.categoryName || '-' }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="isActive">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="isActive" [disableClear]="true">
            <span class="sort-header-content">Status</span>
            <span class="sort-arrows">
              <span class="sort-arrow sort-arrow-up" (click)="sortByColumn('isActive', 'asc'); $event.stopPropagation()" title="Sort ascending">▲</span>
              <span class="sort-arrow sort-arrow-down" (click)="sortByColumn('isActive', 'desc'); $event.stopPropagation()" title="Sort descending">▼</span>
            </span>
          </th>
          <td mat-cell *matCellDef="let product">
            <span [class]="product.isActive ? 'status-active' : 'status-inactive'">
              {{ product.isActive ? 'Active' : 'Inactive' }}
            </span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let product">
            <div class="action-buttons">
              <a [routerLink]="['/admin/products', product.id]" class="btn-link" title="View">
                <mat-icon>visibility</mat-icon>
              </a>
              <a [routerLink]="['/admin/products/edit', product.id]" class="btn-link" title="Edit">
                <mat-icon>edit</mat-icon>
              </a>
              <button class="btn-link btn-danger" (click)="deleteProduct(product.id)" title="Delete">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>

      <!-- No data message -->
      @if (dataSource.data.length === 0 && !isLoading()) {
        <div class="no-data-message">
          <mat-icon>inventory_2</mat-icon>
          <p>No products found</p>
        </div>
      }

      <mat-paginator
        [length]="totalCount()"
        [pageSize]="pageSize()"
        [pageSizeOptions]="[10, 20, 50, 100]"
        [pageIndex]="currentPage() - 1"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </div>
  }
</div>
